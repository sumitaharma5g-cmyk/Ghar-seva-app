<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡§ò‡§∞ ‡§∏‡•á‡§µ‡§æ - Mistri Ji (Updated)</title>
  <meta name="description" content="‡§ò‡§∞ ‡§∏‡•á‡§µ‡§æ - ‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä/‡§ó‡•ç‡§∞‡§æ‡§π‡§ï, UPI ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü, ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§°, ‡§≤‡•ã‡§ï‡•á‡§∂‡§®, Admin" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .fade-in { animation: fadein .6s ease both; }
    @keyframes fadein { from { opacity:0; transform: translateY(6px) } to { opacity:1; transform: none } }
    .star { cursor:pointer; transition: transform .15s }
    .star:hover { transform: scale(1.12) }
    /* small responsive tweaks */
    @media (max-width:640px){ .container{ padding:12px } }
  </style>
</head>
<body class="bg-gray-50">
<!--
  IMPORTANT: Replace placeholders in the script section:
  - REPLACE_WEB_APP_URL
  - REPLACE_CLOUDINARY_UPLOAD_URL
  - REPLACE_UPI_ID
  - (Optional) REPLACE_FIREBASE_CONFIG object for real OTP login
-->

<div id="app" class="min-h-screen"></div>

<script>
/* ---------------------------
   CONFIG ‚Äî EDIT THESE VALUES
   --------------------------- */
const CONFIG = {
  WEB_APP_URL: "REPLACE_WEB_APP_URL",                      // Google Apps Script web app POST/GET endpoint
  CLOUDINARY_UPLOAD_URL: "REPLACE_CLOUDINARY_UPLOAD_URL",  // e.g. https://api.cloudinary.com/v1_1/<cloud_name>/image/upload
  CLOUDINARY_UPLOAD_PRESET: "unsigned_preset_if_any",      // if using unsigned preset; otherwise send via signed server
  UPI_ID: "REPLACE_UPI_ID",                               // your UPI id e.g. 8218197964@ybl
  ADMIN_ALLOWED_PHONE: "+918218197964",                   // admin phone locked (for Firebase OTP)
  ADMIN_FALLBACK_PIN: "1234",                             // local fallback PIN for quick testing
  APP_NAME: "‡§ò‡§∞ ‡§∏‡•á‡§µ‡§æ - Mistri Ji"
};
/* ---------------------------
   END CONFIG
   --------------------------- */

/* Simple i18n labels (hi/en) */
const i18n = {
  hi: {
    welcome: "‡§ò‡§∞ ‡§∏‡•á‡§µ‡§æ ‡§ê‡§™",
    choose: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§§‡§æ‡§è‡§Ç ‚Äî ‡§Ü‡§™ ‡§ï‡•å‡§® ‡§π‡•à‡§Ç?",
    customer: "‡§Æ‡•à‡§Ç ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§π‡•Ç‡§Å",
    worker: "‡§Æ‡•à‡§Ç ‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‡§π‡•Ç‡§Å",
    register: "‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç",
    submit: "‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç",
    pay: "‚Çπ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç",
    uploadPhoto: "‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç",
    locationFetch: "‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§≤‡•Ä‡§ú‡§ø‡§Ø‡•á",
    adminLogin: "Admin ‡§≤‡•â‡§ó‡§ø‡§®",
    logout: "‡§≤‡•â‡§ó‡§Ü‡§â‡§ü",
    requestSent: "‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§≠‡•á‡§ú ‡§¶‡•Ä ‡§ó‡§Ø‡•Ä‡•§",
    fillAll: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç"
  },
  en: {
    welcome: "Ghar Seva App",
    choose: "Tell us ‚Äî who are you?",
    customer: "I'm Customer",
    worker: "I'm Worker",
    register: "Register",
    submit: "Submit",
    pay: "Pay ‚Çπ",
    uploadPhoto: "Upload Photo",
    locationFetch: "Get Location",
    adminLogin: "Admin Login",
    logout: "Logout",
    requestSent: "Request submitted",
    fillAll: "Please fill all required fields"
  }
};

/* App State */
let LANG = 'hi';
let state = {
  view: 'intro', // intro, choose, register, customerDash, workerDash, admin
  userType: null,
  currentUser: null,
  workers: [
    { id:1, name:'‡§∞‡§æ‡§ú‡•á‡§∂ ‡§ï‡•Å‡§Æ‡§æ‡§∞', phone:'9876543210', category:'‡§™‡•ç‡§≤‡§Ç‡§¨‡§ø‡§Ç‡§ó', area:'‡§≤‡§æ‡§ú‡§™‡§§ ‡§®‡§ó‡§∞', upi: 'rajesh@paytm', rating:4.5 },
    { id:2, name:'‡§∏‡•Å‡§∞‡•á‡§∂ ‡§∂‡§∞‡•ç‡§Æ‡§æ', phone:'9876543211', category:'‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡§ø‡§∂‡§ø‡§Ø‡§®', area:'‡§∞‡§æ‡§ú‡•å‡§∞‡•Ä ‡§ó‡§æ‡§∞‡•ç‡§°‡§®', upi:'suresh@phonepe', rating:4.8 }
  ],
  requests: []
};

/* ---------------------
   UTILITIES
   --------------------- */
function t(key){ return (i18n[LANG] && i18n[LANG][key]) ? i18n[LANG][key] : key; }

function el(html){ const d = document.createElement('div'); d.innerHTML = html; return d.firstElementChild; }

function genQRforUPI(upi,name,amount=''){ 
  const upiString = `upi://pay?pa=${upi}&pn=${encodeURIComponent(name)}${amount?`&am=${amount}`:''}&cu=INR`;
  return `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(upiString)}`;
}

/* ---------------------
   RENDERING
   --------------------- */
function renderIntro(){
  document.getElementById('app').innerHTML = `
    <main class="min-h-screen flex items-center justify-center p-6">
      <div class="max-w-md w-full bg-white rounded-2xl shadow-lg p-6 text-center fade-in">
        <div class="text-6xl mb-4">üîß</div>
        <h1 class="text-2xl font-semibold mb-2">${CONFIG.APP_NAME}</h1>
        <p class="text-sm text-gray-600 mb-6">${t('choose')}</p>
        <div class="space-y-3">
          <button onclick="start('customer')" class="w-full py-3 rounded-xl bg-indigo-600 text-white">${t('customer')}</button>
          <button onclick="start('worker')" class="w-full py-3 rounded-xl bg-green-600 text-white">${t('worker')}</button>
          <div class="flex gap-2 justify-center mt-3">
            <button onclick="openAdminLogin()" class="px-3 py-2 bg-gray-200 rounded">${t('adminLogin')}</button>
            <button onclick="toggleLang()" class="px-3 py-2 bg-gray-200 rounded">EN/‡§π‡§ø‡§Ç</button>
          </div>
        </div>
      </div>
    </main>
  `;
}

function renderRegister(userType){
  const isWorker = userType === 'worker';
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen p-6">
      <div class="max-w-xl mx-auto">
        <div class="bg-white p-6 rounded-xl shadow fade-in">
          <h2 class="text-xl font-semibold mb-3">${isWorker? '‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§®' : '‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§®'}</h2>
          <div class="space-y-3">
            <input id="f_name" placeholder="‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ" class="w-full p-3 border rounded" />
            <input id="f_phone" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞" class="w-full p-3 border rounded" />
            ${isWorker ? `<input id="f_cat" placeholder="‡§∏‡•á‡§µ‡§æ (Plumber, Electrician)" class="w-full p-3 border rounded" />
                          <input id="f_upi" placeholder="UPI ID (e.g. your@upi)" class="w-full p-3 border rounded" />` : ''}
            <div class="flex gap-2">
              <button onclick="getLocation()" class="p-3 bg-gray-100 rounded">${t('locationFetch')}</button>
              <div id="locMsg" class="text-sm text-gray-500 self-center"></div>
            </div>
            <div>
              <label class="text-sm font-medium">${t('uploadPhoto')}</label>
              <input id="f_photo" type="file" accept="image/*" class="w-full mt-2" />
            </div>
            <div class="flex gap-2">
              <button onclick="submitRegister('${userType}')" class="flex-1 p-3 bg-indigo-600 text-white rounded">${t('register')}</button>
              <button onclick="renderIntro()" class="flex-1 p-3 bg-gray-200 rounded">${t('logout')}</button>
            </div>
            <div id="regMsg" class="text-sm text-green-600 mt-2"></div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderCustomerDashboard(){
  const categories = [...new Set(state.workers.map(w=>w.category))];
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen">
      <header class="bg-indigo-600 text-white p-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
          <div class="font-semibold">${CONFIG.APP_NAME}</div>
          <div class="flex gap-2 items-center">
            <button onclick="logout()" class="bg-red-500 px-3 py-1 rounded">üö™ ${t('logout')}</button>
            <button onclick="renderAdminLoginFallback()" class="bg-yellow-200 px-3 py-1 rounded text-sm">Admin</button>
          </div>
        </div>
      </header>
      <main class="max-w-4xl mx-auto p-4">
        <section class="bg-white rounded-lg p-4 mb-4">
          <h3 class="font-semibold mb-2">‡§®‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü</h3>
          <select id="req_cat" class="w-full p-3 border rounded mb-2">
            <option value="">‡§∏‡•á‡§µ‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç</option>
            ${categories.map(c=>`<option value="${c}">${c}</option>`).join('')}
          </select>
          <textarea id="req_desc" rows="3" class="w-full p-3 border rounded" placeholder="‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£"></textarea>
          <div class="mt-2">
            <label class="text-sm">‡§´‡•ã‡§ü‡•ã (optional)</label>
            <input id="req_photo" type="file" accept="image/*" class="w-full mt-2" />
          </div>
          <div class="flex gap-2 mt-3">
            <button onclick="submitRequest()" class="flex-1 bg-indigo-600 text-white p-3 rounded">${t('submit')}</button>
            <button onclick="getLocation()" class="flex-1 bg-gray-200 p-3 rounded">${t('locationFetch')}</button>
          </div>
          <div id="reqMsg" class="text-sm text-green-600 mt-2"></div>
        </section>

        <section class="bg-white rounded-lg p-4">
          <h3 class="font-semibold mb-3">‡§®‡§ú‡§º‡•ç‡§¶‡•Ä‡§ï‡•Ä ‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä</h3>
          <div class="grid gap-3 md:grid-cols-2">
            ${state.workers.map(w => `
              <div class="border rounded p-3">
                <div class="flex justify-between items-start">
                  <div>
                    <div class="font-semibold">${w.name}</div>
                    <div class="text-sm text-gray-500">${w.category} ‚Ä¢ ${w.area}</div>
                    <div class="text-sm mt-2">UPI: ${w.upi}</div>
                  </div>
                  <div class="text-right">
                    <div class="text-yellow-400 font-bold">${w.rating}</div>
                    <div class="text-sm"><a href="tel:${w.phone}" class="text-green-600">üìû ‡§ï‡•â‡§≤</a></div>
                  </div>
                </div>
                <div class="flex gap-2 mt-3">
                  <button onclick="openPaymentModal(${w.id})" class="flex-1 bg-green-600 p-2 text-white rounded">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü</button>
                  <button onclick="openWorkerChat(${w.id})" class="flex-1 bg-blue-200 p-2 rounded">‡§ö‡•à‡§ü</button>
                </div>
              </div>`).join('')}
          </div>
        </section>
      </main>
    </div>
  `;
}

function renderWorkerDashboard(){
  const me = state.currentUser;
  const myRequests = state.requests.filter(r=>r.category === me.category);
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen">
      <header class="bg-green-600 text-white p-4">
        <div class="max-w-4xl mx-auto flex justify-between">
          <div class="font-semibold">‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä ‚Ä¢ ${me.name}</div>
          <div><button onclick="logout()" class="bg-red-500 px-3 py-1 rounded">üö™ ${t('logout')}</button></div>
        </div>
      </header>
      <main class="max-w-4xl mx-auto p-4">
        <section class="bg-white p-4 rounded mb-4">
          <h3 class="font-semibold">‡§Ü‡§™‡§ï‡•Ä ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤</h3>
          <p>${me.name} ‚Ä¢ ${me.phone}</p>
          <p class="text-sm">UPI: ${me.upi}</p>
          <img src="${genQRforUPI(me.upi, me.name)}" class="h-36 mt-3" />
        </section>

        <section class="bg-white p-4 rounded">
          <h3 class="font-semibold">‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü‡•ç‡§∏ (${myRequests.length})</h3>
          ${myRequests.length===0?'<p class="text-sm text-gray-500 mt-3">‡§ï‡•ã‡§à ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç</p>':myRequests.map(r=>`
            <div class="border p-3 rounded mt-3">
              <div class="flex justify-between">
                <div><strong>${r.name}</strong><div class="text-sm text-gray-500">${r.phone}</div></div>
                <div class="text-sm text-gray-500">${r.timestamp}</div>
              </div>
              <p class="mt-2">${r.description}</p>
              ${r.photo ? `<img src="${r.photo}" class="h-40 mt-2 rounded" />` : ''}
              <div class="mt-2">
                <a href="tel:${r.phone}" class="bg-green-600 text-white px-3 py-2 rounded">üìû ‡§ï‡•â‡§≤</a>
              </div>
            </div>`).join('')}
        </section>
      </main>
    </div>
  `;
}

/* Payment modal / feedback handled inline */

/* ---------------------
   ACTIONS
   --------------------- */
function start(type){
  state.userType = type;
  renderRegister(type);
}

function openAdminLogin(){
  // open Admin login - use fallback PIN prompt or Firebase OTP if configured
  renderAdminLoginFallback();
}

function renderAdminLoginFallback(){
  const pin = prompt("Enter admin PIN (for quick admin access):");
  if(pin === CONFIG.ADMIN_FALLBACK_PIN){
    state.view = 'admin';
    renderAdminPanel();
  } else {
    alert("Wrong PIN. For real OTP login configure Firebase and use that flow.");
  }
}

async function submitRegister(type){
  const name = document.getElementById('f_name').value.trim();
  const phone = document.getElementById('f_phone').value.trim();
  const photoInput = document.getElementById('f_photo');
  const locMsg = document.getElementById('locMsg')?.innerText || '';

  if(!name || !phone){ return alert(t('fillAll')); }

  let uploadedImageUrl = '';
  if(photoInput && photoInput.files && photoInput.files[0]){
    try{
      uploadedImageUrl = await uploadImageToCloudinary(photoInput.files[0]);
    }catch(err){
      console.error(err);
      alert('Image upload failed ‚Äî continuing without image.');
    }
  }

  const payload = {
    action: type==='worker' ? 'register_worker' : 'register_customer',
    name, phone,
    category: type==='worker' ? document.getElementById('f_cat')?.value || '' : '',
    upi: type==='worker' ? document.getElementById('f_upi')?.value || '' : '',
    area: locMsg || '',
    photo: uploadedImageUrl,
    timestamp: new Date().toLocaleString('hi-IN')
  };

  // local add
  if(type==='worker'){
    const newid = Date.now();
    const newWorker = { id:newid, name:payload.name, phone:payload.phone, category:payload.category||'‡§Ö‡§®‡•ç‡§Ø', area:payload.area||'', upi:payload.upi||'', rating:0 };
    state.workers.push(newWorker);
    state.currentUser = newWorker;
    state.userType = 'worker';
    state.view = 'workerDash';
    renderWorkerDashboard();
  } else {
    state.currentUser = { id:Date.now(), name:payload.name, phone:payload.phone };
    state.userType = 'customer';
    state.view = 'customerDash';
    renderCustomerDashboard();
  }

  // send to backend (Apps Script)
  try{
    await postToWebApp(payload);
  }catch(e){
    console.warn('webapp post failed', e);
  }
}

function logout(){ state.userType=null; state.currentUser=null; state.view='intro'; renderIntro(); }

/* Requests */
async function submitRequest(){
  const cat = document.getElementById('req_cat').value;
  const desc = document.getElementById('req_desc').value.trim();
  const photoEl = document.getElementById('req_photo');
  if(!cat || !desc) return alert(t('fillAll'));

  let photoUrl = '';
  if(photoEl && photoEl.files && photoEl.files[0]){
    try{ photoUrl = await uploadImageToCloudinary(photoEl.files[0]); }catch(e){ console.warn(e); }
  }

  // try get geolocation (best effort)
  let loc = '';
  try{
    const pos = await getCurrentPosition(5000);
    loc = `${pos.coords.latitude.toFixed(6)},${pos.coords.longitude.toFixed(6)}`;
  }catch(e){ /* ignore */ }

  const req = {
    id: Date.now(),
    name: state.currentUser?.name || 'Guest',
    phone: state.currentUser?.phone || '',
    category: cat,
    description: desc,
    photo: photoUrl,
    location: loc,
    timestamp: new Date().toLocaleString('hi-IN')
  };
  state.requests.push(req);

  // Send to backend
  try{ await postToWebApp({ action:'customer_request', ...req }); }catch(e){ console.warn(e); }

  document.getElementById('reqMsg').innerText = t('requestSent');
  // reset
  document.getElementById('req_desc').value = '';
  document.getElementById('req_photo').value = '';
  renderCustomerDashboard();
}

/* Payment flow - open payment modal simplified */
function openPaymentModal(workerId){
  const worker = state.workers.find(w=>w.id===workerId);
  if(!worker) return alert('Worker not found');
  // show small modal using window prompt (simpler for single-file)
  const amount = prompt('Enter amount to pay (‚Çπ)');
  if(!amount || isNaN(amount)) return alert('Valid amount needed');
  const q = genQRforUPI(worker.upi || CONFIG.UPI_ID, worker.name, amount);
  // show QR in new window
  const win = window.open('', '_blank', 'width=360,height=600');
  win.document.write(`<div style="font-family:Arial;padding:12px;text-align:center">
    <h3>Pay ‚Çπ${amount} to ${worker.name}</h3>
    <img src="${q}" style="width:240px;height:240px;margin:12px;border-radius:8px"/><p>UPI: ${worker.upi || CONFIG.UPI_ID}</p>
    <p><button onclick="window.close()">Close</button></p>
    </div>`);
}

/* Chat placeholder (local only) */
function openWorkerChat(workerId){
  const worker = state.workers.find(w=>w.id===workerId);
  if(!worker) return;
  const msg = prompt(`Send message to ${worker.name} (this demo doesn't send messages)`);
  if(msg) alert('Message noted (demo)');
}

/* ---------------------
   HELPERS: geolocation, Cloudinary upload, webapp POST
   --------------------- */
function getCurrentPosition(timeout=7000){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error('Not supported'));
    const t = setTimeout(()=>reject(new Error('Timeout')), timeout);
    navigator.geolocation.getCurrentPosition(pos=>{ clearTimeout(t); resolve(pos); }, err=>{ clearTimeout(t); reject(err); }, { timeout });
  });
}

async function uploadImageToCloudinary(file){
  if(!CONFIG.CLOUDINARY_UPLOAD_URL || CONFIG.CLOUDINARY_UPLOAD_URL.includes('REPLACE_CLOUDINARY')){
    throw new Error('Cloudinary not configured');
  }
  const form = new FormData();
  form.append('file', file);
  if(CONFIG.CLOUDINARY_UPLOAD_PRESET) form.append('upload_preset', CONFIG.CLOUDINARY_UPLOAD_PRESET);
  const res = await fetch(CONFIG.CLOUDINARY_UPLOAD_URL, { method:'POST', body: form });
  if(!res.ok) throw new Error('Upload failed');
  const data = await res.json();
  return data.secure_url || data.url || '';
}

async function postToWebApp(payload){
  if(!CONFIG.WEB_APP_URL || CONFIG.WEB_APP_URL.includes('REPLACE_WEB_APP_URL')){
    console.warn('WEB_APP_URL missing, skipping server post');
    return;
  }
  const form = new FormData();
  for(const k in payload) form.append(k, payload[k]);
  const res = await fetch(CONFIG.WEB_APP_URL, { method:'POST', body: form });
  return res.text();
}

/* ---------------------
   ADMIN PANEL (simple) - reads from Apps Script list endpoint
   --------------------- */
function renderAdminPanel(){
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen p-4">
      <div class="max-w-4xl mx-auto bg-white p-4 rounded shadow">
        <div class="flex justify-between items-center">
          <h2 class="font-semibold">Admin Panel</h2>
          <div><button onclick="renderIntro()" class="px-3 py-1 bg-gray-200 rounded">Exit</button></div>
        </div>
        <div class="mt-4">
          <button onclick="loadRegistrations()" class="px-3 py-2 bg-indigo-600 text-white rounded">Load registrations</button>
          <div id="adminMsg" class="mt-2 text-sm"></div>
        </div>
        <div id="adminList" class="mt-4"></div>
      </div>
    </div>
  `;
}

async function loadRegistrations(){
  const out = document.getElementById('adminList');
  out.innerHTML = 'Loading...';
  if(!CONFIG.WEB_APP_URL || CONFIG.WEB_APP_URL.includes('REPLACE_WEB_APP_URL')){
    out.innerHTML = '<div class="text-sm text-red-500">WEB_APP_URL not configured</div>';
    return;
  }
  try{
    const res = await fetch(CONFIG.WEB_APP_URL + '?action=list');
    const data = await res.json();
    if(!Array.isArray(data)) throw new Error('Invalid response');
    out.innerHTML = `<table class="w-full text-left border-collapse"><thead><tr><th class="p-2 border">Time</th><th class="p-2 border">Action</th><th class="p-2 border">Name</th><th class="p-2 border">Phone</th></tr></thead><tbody>` +
      data.map(r=>`<tr><td class="p-2 border">${r.timestamp||''}</td><td class="p-2 border">${r.action||''}</td><td class="p-2 border">${r.name||''}</td><td class="p-2 border">${r.phone||''}</td></tr>`).join('') +
      `</tbody></table>`;
  }catch(err){
    console.error(err);
    out.innerHTML = `<div class="text-sm text-red-500">Failed to load: ${err.message}</div>`;
  }
}

/* ---------------------
   INIT
   --------------------- */
function toggleLang(){ LANG = LANG === 'hi' ? 'en' : 'hi'; /* re-render current view */ renderCurrentView(); }
function renderCurrentView(){
  if(state.view === 'intro' || !state.view) renderIntro();
  else if(state.userType && !state.currentUser) renderRegister(state.userType);
  else if(state.userType === 'customer') renderCustomerDashboard();
  else if(state.userType === 'worker') renderWorkerDashboard();
  else if(state.view === 'admin') renderAdminPanel();
  else renderIntro();
}

/* helper to generate UPI QR (used in worker dashboard) */
function genQRforUPI(upi,name,amount=''){ return genQRforUPI; }

/* tiny bugfix: local name for QR */
function genQRforUPI(upi,name,amt=''){ return `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(`upi://pay?pa=${upi}&pn=${name}${amt?`&am=${amt}`:''}&cu=INR`)}`; }

/* start app */
renderIntro();

</script>
</body>
</html>
